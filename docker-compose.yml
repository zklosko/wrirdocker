version: '3.8'

services:
  json:
    image: httpd
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
    volumes:
      - ./htdocs:/var/local/apache2/htdocs
      - ./cgi-bin:/var/local/apache2/cgi-bin
      - ./httpd.conf:/var/local/apache2/conf/httpd.conf
      - ${APACHE_LOG_VOLUME}:
      - ${APACHE_CONF}:
      - ${SSL_VOLUME}:
    networks:
      wrir_stack:
        ipv4_address: 192.168.200.36
    restart: always
    
  icecast:
    image: infiniteproject/icecast
    enviornment:
      ICECAST_SOURCE_PASSWORD: wwr4trou
      ICECAST_ADMIN_PASSWORD: wwr4trou
      ICECAST_RELAY_PASSWORD: wwr4trou
      ICECAST_ADMIN_USERNAME: wrirops
      ICECAST_ADMIN_EMAIL: operations@wrir.org
      ICECAST_LOCATION: Richmond, VA
      ICECAST_HOSTNAME: bandito
      ICECAST_MAX_CLIENTS: 50
      ICECAST_MAX_SOURCES: 2
    ports:
      - target: 8000
        published: 8000
        protocol: tcp
        mode: host
    networks:
      wrir_stack:
        ipv4_address: 192.168.200.37
    restart: always
    
  stream-recorder:
    build: stream-recorder/.
    volumes:
      - stream-recorder/scripts:/scripts
    depends_on:
      - icecast
    restart: always
    
  webdav:
    image: twizzel/webdav
    restart: always
    ports:
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    environment:
      AUTH_TYPE: Basic
      SERVER_NAMES: files.wrir.org
      REALM: WRIR Network Drives
    volumes:
      - mounts:/var/lib/dav/data
      - user.passwd:/user.passwd
      - localhost.key:/privkey.pem
      - localhost.cert:/cert.pem
    networks:
      wrir_stack:
        ipv4_address: 192.168.200.39
        
  ssh:
    image: panubo/sshd
    restart: always
    ports:
      - target: 22
        published: 22
        protocol: tcp
        mode: host
    enviornment:
      SSH_ENABLE_PASSWORD_AUTH: true
    volumes:
      - keys:/etc/ssh/keys
      - setpasswd.sh:/etc/entrypoint.d/
    networks:
      wrir_stack:
        ipv4_address: 192.168.200.40
        
networks:
  wrir_stack:
    driver: macvlan
    driver_opts:
      parent: <eth card name>
    ipam:
      config:
        - subnet: "192.168.200.0/24"
          gateway: "192.168.200.1"
